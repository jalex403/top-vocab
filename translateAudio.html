<!DOCTYPE html>
<html>
<head>
<!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>-->
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="themes/jac-theme1.min.css" />
        <link rel="stylesheet" href="themes/jquery.mobile.icons.min.css" />
        <link rel="stylesheet" href="jquery.mobile.structure-1.4.2.min.css" /> 
        <script src="jquery-1.8.2.min.js"></script>
        <script src="jquery.mobile-1.4.2.min.js"></script>
        <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>-->
        <script type="text/javascript">
            document.write('<link rel="apple-touch-startup-image" href="images/startup'+(navigator.platform=='iPad'?'_ipad':'')+'.jpg">');
          </script>
        <link rel="apple-touch-icon" href="images/icon.png"/>
<script>
    


 function ajaxTranslateCallback(response) {
  // Display translated text in the right textarea.
  $("#audio").attr('src', response);
//   alert("src set");
//$("#audio").trigger('load');
//$("#audio").trigger('play');
}
//
//  var contextClass = (window.AudioContext || 
//  window.webkitAudioContext || 
//  window.mozAudioContext || 
//  window.oAudioContext || 
//  window.msAudioContext);  

    $(document).ready(function() {
        
        
// var contextClass = (window.AudioContext || 
//  window.webkitAudioContext || 
//  window.mozAudioContext || 
//  window.oAudioContext || 
//  window.msAudioContext);
//if (contextClass) {
//  // Web Audio API is available.
//  var context = new contextClass();
 
//}

$("#audio").attr('src', "./test.mp3");      
var g_token = '';
onLoad();

var Loader = setInterval(loadingMsg, 500);

//var ctr = 0;

function loadingMsg(){ 
    if( typeof loadingMsg.ctr == 'undefined' ) {
                    loadingMsg.ctr = 0;
                }
    var counter = 0;
    counter = loadingMsg.ctr;
    ++loadingMsg.ctr;
    $('<span> . </span>').appendTo("#loading");
    if (loadingMsg.ctr == 5){
      $("#loading").html("Loading");  
      loadingMsg.ctr = 0;
      
    }  
//    console.log(loadingMsg.ctr);
}

function onLoad() {
  // Get an access token now.  Good for 10 minutes.
  getToken();
  // Get a new one every 9 minutes.
  setInterval(getToken, 9 * 60 * 1000);
 
}

            $.ajaxSetup({   
                beforeSend: function() {
//                     $loading.show();
                     console.log("ajaxstart");
                  },
                  complete: function(){
//                     $loading.hide();
                     console.log("ajaxend");
                  },
                  error: function(jqXHR, textStatus, errorThrown){
//                      $(".e-word").css("background-color", colorBackground);  
//                      $loading.hide();
//                      alert("Error, try again/intente otra vez");
                      alert("An error occured: " + textStatus + " " + errorThrown);
                  },
                async: false
                });

function getToken() {
  var requestStr = "./token.php";


  $.ajax({
    url: requestStr,
    type: "GET",
    cache: true,
    dataType: 'json',
    success: function (data) {
      g_token = data.access_token;
    }
  });
}

function translate(text, from, to) {
  var p = new Object;
  p.text = text;
  p.format = "audio/mp3";
  p.language = from;
  p.options = "MinSize";

  // A major puzzle solved.  Who would have guessed you specify the jsonp callback in oncomplete?
//  p.oncomplete = 'ajaxTranslateCallback';
  
 // Another major puzzle.  The authentication is supplied in the deprecated appId param.
  p.appId = "Bearer " + g_token;

  var requestStr = "http://api.microsofttranslator.com/V2/Ajax.svc/Speak";

  $.ajax({
    url: requestStr,
    type: "GET",
    data: p,
    dataType: 'jsonp',
    jsonp: 'oncomplete',
    jsonpCallback:'ajaxTranslateCallback',
    cache: true,
    async: false
  });
}

 $("#translateButton").on("click", function(){
// alert(context);
     translateSourceTarget();
     console.log("speak");
$("#audio").trigger('load');
//     alert("play");
     $("#audio").trigger('play');
 });
 
 $("#playNow").on("click", function(){
//     var srcNow =  $("#audio").attr('src');
//      $("#audio").attr('src', srcNow);
     $("#audio").trigger('load');
     console.log("play");
//                $("#audio").bind("load",function(){
//                console.log("audio loaded");
                   $("#audio").trigger('play');
//                });
//     $("#audio").trigger('play');
//                    audio.get(0).load();
//                    audio.get(0).play();
 });
 
//function ajaxTranslateCallback(response) {
//  // Display translated text in the right textarea.
//  $("#audio").attr('src', response);
////$("#audio").trigger('load');
////$("#audio").trigger('play');
//}

function translateSourceTarget() {
  // Translate the text typed by the user into the left textarea.
  var src = $("#source").val();
  translate(src, "en", "fr");
//  alert("load");
//$("#audio").trigger('load');
//alert("play");
//$("#audio").trigger('play');
//var link = "http://translate.google.com/translate_tts?tl=en&q=" + encodeURI(src);
//$('#tts').prop("src",link)


}

$('#btnPlay').bind('mousedown', function() {
//    $(this).css('background-color', 'black');
    $(this).addClass('ui-btn-active');
});

$('#btnPlay').bind('mouseup', function() {
//    $(this).css('background-color', 'white');
    $(this).removeClass('ui-btn-active');
});


    });
    

    
</script>
<style>
/*#source, #target {
  position:relative;
  float:left;
  width:400px;
  height: 50px;
  padding:10px;
  margin: 10px;
  border: 1px solid black;
}*/

/*.translateButton {
  float:left;
  margin: 10px;
  height:50px;
  background-color: red;
}*/
</style>
</head>

<body>
<!--<body onload="onLoad();">-->

<textarea id="source">Text typed here will be spoken.</textarea>
<button id="translateButton" >Load and Speak!</button>
<button id="playNow" >Speak!</button>
<!--<button class="ui-btn ui-mini" id="btnPlay" >Test</button>-->
<div class="needConnection">
                <div><input type="text" id="word" placeholder="Entre palabra en ingles.." data-mini="true"></div>
                <div><button id="btnPlay" class="ui-btn ui-btn-corner-all ui-mini ui-icon-audio"  >Pronunciar</button></div>
            </div>
<!--<button id="translateButton" onclick="translateSourceTarget();">Translate English to French</button>-->
<!--<textarea id="target"></textarea>-->
<audio id="audio" ><source src="/test.mp3" type="audio/mpeg"/></audio>
<div id="loading" style="position: fixed; left: 5px; top:5px;">Loading</div>
<!--<iframe id='tts' src="demo_iframe.htm" width="100%" height="100"></iframe>-->
</body>
</html>